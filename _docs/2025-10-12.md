# RustでのMCPの取り扱い

## 背景
- CodexはサブエージェントとDeep Research拡張に合わせてMCPを通じたツール連携・権限管理を中核化する方針。
- サーバー側で安全なツール権限やトークン予算管理を行い、CLI/IDE/Webなど既存導線を壊さず拡張することが目的。

## Rust実装コンポーネント
- `mcp-types`：公式スキーマ（2025-06-18版）から生成された型と`ModelContextProtocolRequest`/`ModelContextProtocolNotification`トレイトを提供。
- `mcp-client`：TokioベースのSTDIOクライアント。`new_stdio_client`でサーバープロセスを起動し、`send_request`/`send_notification`や`initialize`・`list_tools`・`call_tool`のヘルパーを備える。
- `mcp-server`：CodexをMCPサーバーとして公開。`MessageProcessor`がJSON-RPCメッセージをハンドリングし、`tools/list`でCodex/Deep Research/サブエージェント等のツールを提供、`tools/call`で各ハンドラーへ委譲。

## 基本フロー
1. `McpClient::new_stdio_client`でMCPサーバーを起動。
2. `initialize`要求と`notifications/initialized`通知でハンドシェイク。
3. `tools/list`で有効なツールを確認し、`tools/call`でCodex本体やDeep Research、サブエージェントなどを実行。

## ドキュメント参照
- `docs/codex-subagents-deep-research.md`
- `codex-rs/docs/codex_mcp_interface.md`
- `codex-rs/mcp-types/src/lib.rs`
- `codex-rs/mcp-client/src/mcp_client.rs`
- `codex-rs/mcp-server/src/message_processor.rs`
