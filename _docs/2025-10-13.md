# Code Review – codex-rs/core

## Blocking Issues
- **[P0] Canonicalize write allowlist before matching** — `codex-rs/core/src/agents/permission_checker.rs:58-79`. Raw path comparisons allow traversal such as `/tmp/allowed/../../etc/passwd`, letting restricted agents escape their sandbox. Resolve or reject candidate paths before applying allowlist checks.
- **[P0] Drop notification lock before awaiting recv** — `codex-rs/core/src/async_subagent_integration.rs:67-95`. Holding the `notification_rx` mutex across `recv().await` blocks APIs like `check_inbox`, effectively deadlocking inbox access once monitoring starts.

## High-Priority Issues
- **[P1] Reset agent token usage when limit changes** — `codex-rs/core/src/agents/budgeter.rs:31-55`. `try_consume` uses cumulative usage without resetting when new limits are set, so agents eventually exceed budget even if each run is under quota. Clear the tracked usage (or charge only deltas) per task.

## Overall Verdict
- **Overall correctness:** patch is incorrect. Blocking issues remain around permission enforcement and sub-agent monitoring locks; token accounting also misbehaves across runs.

## Notes
- Findings sourced via `codex-agent` review of `codex-rs/core`, focused on code quality, best practices, and potential bugs.
