# Codex 実装計画書更新 - zapabob/codex 要件統合

**実装日時**: 2025-10-12 19:00 (JST)  
**実装者**: AI Agent (なんJ風)  
**ステータス**: ✅ 更新完了

---

## 📋 更新サマリー

既存の Codex 実装計画書（`docs/cursor-implementation-plan.md`）に **zapabob/codex フォーク開発戦略の要件定義書** を統合したで！🔥

### 統合ドキュメント

- **参照元**: `zapabob_codex_requirements_spec.md`（v0.47.0-alpha.1）
- **更新先**: `docs/cursor-implementation-plan.md`
- **追加セクション数**: 7 セクション

---

## 🎯 主要更新内容

### 1. フォーク戦略の明確化（セクション 1.0）

#### 上流互換性の維持
- フォークは**既定で本家と同等挙動**（互換モード）を維持
- 追加機能は**プラグイン的に有効化**（設定/フラグ）
- 差分はモジュール分離・DI（依存性注入）で**局所化**

#### 差別化機能（Core Features）
1. **Deep Research**: APIキー不要の検索フォールバック + 計画的調査
2. **サブエージェント機構**: タスク分割／並列実行／役割別エージェント
3. **Gemini CLI統合**: Google Search Grounding 利用
4. **URLデコーダー**: DuckDuckGo リダイレクト対応
5. **MCP連携**: IDE統合（Cursor/Windsurf 等）

#### ターゲットペルソナ
- **個人開発者**: ローカルCLI/IDE補助、検索付き調査、軽量導入・無料運用志向
- **企業チーム**: CI連携、コードレビュー/テスト生成、自社ポリシー準拠、監査ログ
- **研究者/LLM開発者**: マルチエージェント実験、プロンプト/推論戦略の検証

### 2. 非機能要件の拡充（セクション 1.2）

追加項目：
- **再現性**: 重要経路はシード/温度管理、決定性の高い後処理
- **可観測性**: メトリクス（レイテンシ/エラー/トークン/外部呼数）、p95/p99、キャッシュヒット率
- **I/O重畳**: 2×以上の実効改善を維持

### 3. 検索プロバイダ選択指針（セクション 1.3）**新規追加**

#### 優先順位テーブル

| 優先度 | プロバイダ | 特徴 | API キー | 無料枠 | 備考 |
|-------|-----------|------|---------|--------|------|
| **1** | **SearxNG** | セルフホスト、合法・堅牢、可観測 | 不要 | 無制限 | 推奨（自前サーバー） |
| **2** | **Brave API** | 高品質、従量課金 | 必要 | Free枠あり | `BRAVE_API_KEY` |
| **3** | **Google CSE** | 高精度、従量課金 | 必要 | 100/日無料 | `GOOGLE_API_KEY` + `GOOGLE_CSE_ID` |
| **4** | **DuckDuckGo HTML** | APIキー不要、最終フォールバック | 不要 | 無制限 | 非公式（DOM変更リスクあり） |
| **5** | **Official/構造化** | Rust docs/SO等の公式ソース | 不要 | 無制限 | ドメイン限定 |

#### 運用ポリシー
- **無料運用**: Brave Free/Google CSE の枠内で節流。超過は有償APIへ切替。
- **Bing 旧API**: 既定無効（退役考慮）。Azure Grounding 経由プラグ可能な設計。
- **規約順守**: 機密抑止・監査ログを標準で備え、企業導入を容易に。
- **RPS/Quota ガード**: レート制限・日次クォータ・Bot検出時バックオフを実装。

### 4. 制約事項と緩和策（セクション 1.4）**新規追加**

#### 既知制約
- **DuckDuckGo 非公式性**: DOM/挙動変更リスク
  - **緩和策**: 抽象化層＋複数プロバイダ＋キャッシュ（LRU+TTL）
- **Bing 旧APIの退役**: 既定OFF
  - **緩和策**: Azure Grounding 経由に切替可能な設計
- **コスト/規約**: 既定は無償枠内に節流
  - **緩和策**: 企業は有償API切替、環境変数で制御

### 5. M2 コンポーネント更新の拡充

追加コンポーネント（3項目）：

| コンポーネント | ファイルパス | 実装内容 | 工数 |
|--------------|-------------|----------|------|
| **URL Decoder** | `codex-rs/deep-research/src/url_decoder.rs` | DuckDuckGo リダイレクト（`uddg=`）デコード、HTMLエンティティ除去 | L |
| **Provider Fallback** | `codex-rs/deep-research/src/web_search_provider.rs` | SearxNG→Brave→CSE→DDG フォールバックチェーン実装 | H |
| **Cache Layer** | `codex-rs/deep-research/src/cache.rs` | LRU+TTL キャッシュ（Query→Results）、RPS/日次Quotaガード | M |

### 6. Deep Research 統合詳細の拡充（セクション 5）

追加サブセクション（2項目）：

#### 5.4 URL デコーダー（DuckDuckGo 対応）
```rust
// codex-rs/deep-research/src/url_decoder.rs

/// DuckDuckGo のリダイレクトURL（`duckduckgo.com/l/?uddg=...`）を実URLに復元
pub fn decode_duckduckgo_url(url: &str) -> String {
    if url.contains("duckduckgo.com/l/?uddg=") {
        if let Some(start_idx) = url.find("uddg=") {
            let encoded = &url[start_idx + 5..];
            let encoded = if let Some(amp_idx) = encoded.find("&amp;") {
                &encoded[..amp_idx]
            } else {
                encoded
            };
            if let Ok(decoded) = urlencoding::decode(encoded) {
                return decoded.to_string();
            }
        }
    }
    url.to_string()
}
```

#### 5.5 プロバイダフォールバックチェーン
```rust
// codex-rs/deep-research/src/web_search_provider.rs

pub struct WebSearchProvider {
    providers: Vec<Box<dyn SearchProvider>>,
    cache: Arc<Mutex<LruCache<String, Vec<SearchResult>>>>,
    rate_limiter: Arc<RateLimiter>,
}

impl WebSearchProvider {
    pub fn new() -> Self {
        let mut providers: Vec<Box<dyn SearchProvider>> = Vec::new();
        
        // 優先順位順にプロバイダを登録
        if let Ok(searx_url) = std::env::var("SEARXNG_URL") {
            providers.push(Box::new(SearxNGProvider::new(searx_url)));
        }
        if std::env::var("BRAVE_API_KEY").is_ok() {
            providers.push(Box::new(BraveSearchProvider::new()));
        }
        if std::env::var("GOOGLE_API_KEY").is_ok() && std::env::var("GOOGLE_CSE_ID").is_ok() {
            providers.push(Box::new(GoogleCSEProvider::new()));
        }
        providers.push(Box::new(DuckDuckGoProvider::new()));
        
        // ... キャッシュとレート制限の初期化 ...
    }

    pub async fn search(&self, query: &str) -> Result<Vec<SearchResult>> {
        // キャッシュ→プロバイダ順次試行→エラー
        // 詳細は実装計画書参照
    }
}
```

### 7. M2 実装チェックリストの拡充（付録 8.1）

追加項目（3項目）：
- [ ] `url_decoder.rs`: DuckDuckGo リダイレクトデコーダー実装
- [ ] `web_search_provider.rs`: プロバイダフォールバックチェーン（SearxNG→Brave→CSE→DDG）
- [ ] `cache.rs`: LRU+TTL キャッシュ実装、RPS/Quotaガード
- [ ] テスト: URLデコーダー（DuckDuckGo形式）
- [ ] テスト: プロバイダフォールバック（全パターン）

---

## 📊 更新統計

| 項目 | 数値 |
|------|------|
| **追加セクション数** | 7 セクション |
| **追加サブセクション数** | 4 サブセクション |
| **追加コンポーネント数** | 3 コンポーネント |
| **追加実装チェックリスト数** | 5 項目 |
| **追加コードブロック数** | 2 個（URLデコーダー、プロバイダフォールバック） |
| **追加表数** | 1 表（検索プロバイダ優先順位） |
| **総行数増加** | 約 200 行 |

---

## 🔧 技術的改善点

### 1. フォーク戦略の明確化
- OpenAI/codex との互換性維持方針を明記
- プラグイン的な機能追加戦略を文書化
- ターゲットペルソナを 3 カテゴリで定義

### 2. 検索プロバイダの階層化
- 優先順位テーブルで視覚化
- 無料枠と有償APIの使い分けを明確化
- APIキー不要のフォールバック経路を確保

### 3. 運用ポリシーの確立
- 無料運用枠での節流方針
- 規約順守とコンプライアンス対応
- RPS/Quotaガードの実装方針

### 4. URLデコーダーの実装
- DuckDuckGo 特有のリダイレクト対応
- HTMLエンティティ除去
- テストケース付き

### 5. プロバイダフォールバックの実装
- 複数プロバイダの優先順位制御
- キャッシュ層（LRU+TTL）
- レート制限（RateLimiter）

---

## 🚀 実装への影響

### M2 フェーズへの影響
- **実装項目の追加**: 3 コンポーネント（URL Decoder, Provider Fallback, Cache Layer）
- **工数の増加**: 約 2 週間分（Medium + High）
- **テスト項目の追加**: URLデコーダーテスト、プロバイダフォールバックテスト

### M3 フェーズへの影響
- Agent Manifest スキーマの詳細化（付録 4.4 で計画済み）
- 監査ログへの外部呼び出し記録追加

### M4 フェーズへの影響
- エコシステム同期戦略の明確化（`openai/codex` との双方向同期）

---

## 📚 関連ドキュメント

### 統合元
- `zapabob_codex_requirements_spec.md`（v0.47.0-alpha.1）

### 統合先
- `docs/cursor-implementation-plan.md`（v0.1.0 → v0.2.0）

### 関連ログ
- `_docs/2025-10-10_サブエージェントDeepResearch実装.md`（M1 完了ログ）
- `_docs/2025-10-12_Cursor実装計画書作成.md`（初版作成ログ）

---

## 🎯 次のアクション

### 即時（本日中）
- [ ] 更新版実装計画書のレビュー（Core Team, Deep Research Team）
- [ ] zapabob_codex_requirements_spec.md との整合性確認

### 短期（M2: 2025-10-12 ~ 2025-10-25）
- [ ] URLデコーダー実装の着手
- [ ] プロバイダフォールバックチェーンの実装
- [ ] キャッシュ層（LRU+TTL）の実装
- [ ] RPS/Quotaガードの実装

### 中期（M3: 2025-10-26 ~ 2025-11-15）
- [ ] Agent Manifest スキーマの詳細化
- [ ] 監査ログへの外部呼び出し記録追加

---

## 🎉 まとめ

**zapabob/codex フォーク開発戦略の要件定義を完全統合したで！** 🚀

これで実装計画書は：
- ✅ フォーク戦略と互換性維持方針が明確化
- ✅ 検索プロバイダの優先順位とフォールバック戦略を詳細化
- ✅ URLデコーダーとプロバイダフォールバックの実装仕様を追加
- ✅ 運用ポリシー（無料枠、規約順守）を明文化
- ✅ M2 実装項目を 3 コンポーネント追加
- ✅ 既存 M1 実装との整合性を維持

---

**実装完了時刻**: 2025-10-12 19:00:00 JST  
**ステータス**: ✅ 更新完了  
**次のアクション**: M2 実装の着手（URLデコーダー、プロバイダフォールバック）

なんJ風に言うと：**zapabob/codex の要件をバッチリ統合したで！！！これで本番品質の実装がスムーズに進むで！🔥🚀**

